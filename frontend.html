<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>P2P Live Guestbook â€“ Postman Echo WebSocket</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  body {font-family:system-ui;background:#000;color:#0f0;padding:30px;margin:0;}
  input,textarea,button{width:100%;padding:12px;margin:10px 0;background:#111;color:#0f0;border:2px solid #0f0;font-size:16px;box-sizing:border-box;}
  button{background:#0f0;color:#000;font-weight:bold;cursor:pointer;}
  button:disabled{background:#333;color:#666;cursor:not-allowed;}
  .msg{border:1px solid #0f0;padding:10px;margin:10px 0;background:#001100;}
  .name{font-weight:bold;}
  .time{font-size:12px;color:#0a0;}
  #peers{position:fixed;top:10px;right:10px;background:#000;border:1px solid #0f0;padding:8px;border-radius:4px;}
  .status{position:fixed;top:50px;right:10px;background:#000;border:1px solid #0f0;padding:8px;border-radius:4px;}
  .connection-status {margin:10px 0;padding:8px;border-radius:4px;}
  .connection-status.connected {background:#001100;border:1px solid #0f0;}
  .connection-status.disconnected {background:#110000;border:1px solid #f00;}
  .connection-status.connecting {background:#111100;border:1px solid #ff0;}
  .server-info {margin:10px 0;padding:10px;background:#111;border:1px solid #0f0;}
  .info-box {margin:20px 0;padding:15px;background:#111;border:1px solid #0f0;}
</style>
</head>
<body>

<h1>P2P Live Guestbook â€“ Postman Echo WebSocket</h1>
<p>Using reliable Postman Echo server for real-time messaging</p>

<div class="connection-status" id="connectionStatus">Connecting to Postman Echo...</div>

<div class="server-info">
  <strong>WebSocket Server:</strong> <code>wss://ws.postman-echo.com/raw</code><br>
  <strong>Status:</strong> <span id="serverStatus">Connecting...</span><br>
  <button id="reconnectBtn">Reconnect</button>
</div>

<input type="text" id="name" placeholder="Your name (optional)" value="Visitor">
<textarea id="msg" rows="3" placeholder="Your message â€“ will echo back from server"></textarea>
<button id="sendBtn" disabled>Send Message (Connecting...)</button>

<div id="messages"></div>
<div class="status" id="status">Status: Connecting to Postman Echo</div>
<div class="peers" id="peers">Echoes: 0</div>

<script type="module">
// DOM elements
const connectionStatus = document.getElementById('connectionStatus');
const statusDiv = document.getElementById('status');
const peersDiv = document.getElementById('peers');
const sendBtn = document.getElementById('sendBtn');
const messagesDiv = document.getElementById('messages');
const serverStatusDiv = document.getElementById('serverStatus');
const reconnectBtn = document.getElementById('reconnectBtn');

// Connection state
let ws = null;
let isConnected = false;
let messageCount = 0;
let echoCount = 0;

// Message storage
let messages = [];

// Postman Echo WebSocket URL
const WS_URL = 'wss://demo.piesocket.com/v3/channel_123?api_key=VCXCEuvhGcBDP7XhiJJUDvR1e1D3eiVjgZ9VRiaV&notify_self';

// Initialize WebSocket connection
function initializeWebSocket() {
  // Cleanup previous connection
  if (ws) {
    ws.close();
    ws = null;
  }
  
  updateConnectionStatus('connecting', 'Connecting to Postman Echo...');
  serverStatusDiv.textContent = 'Connecting...';
  sendBtn.disabled = true;
  
  try {
    ws = new WebSocket(WS_URL);
    
    ws.onopen = () => {
      console.log('âœ… Connected to Postman Echo WebSocket');
      isConnected = true;
      updateConnectionStatus('connected', 'âœ… Connected to Postman Echo');
      serverStatusDiv.textContent = 'âœ… Connected - Ready for messages';
      sendBtn.disabled = false;
      updateStatus('Connected - Send a message to test');
      
      // Send a welcome message
      const welcomeMessage = {
        type: 'system',
        text: 'Connected to Postman Echo WebSocket server. Send a message and it will echo back!',
        time: Date.now(),
        id: 'welcome'
      };
      addMessage(welcomeMessage);
    };
    
    ws.onmessage = (event) => {
      console.log('ðŸ“¨ Received echo:', event.data);
      echoCount++;
      peersDiv.textContent = `Echoes: ${echoCount}`;
      
      try {
        // Try to parse as JSON first
        const data = JSON.parse(event.data);
        handleReceivedMessage(data, true);
      } catch (e) {
        // If not JSON, treat as plain text echo
        handleReceivedMessage({
          text: event.data,
          isEcho: true,
          time: Date.now(),
          id: 'echo-' + Date.now()
        }, true);
      }
    };
    
    ws.onclose = (event) => {
      console.log('âŒ WebSocket closed:', event.code, event.reason);
      isConnected = false;
      updateConnectionStatus('disconnected', `Disconnected: ${event.reason || 'Connection closed'}`);
      serverStatusDiv.textContent = 'âŒ Disconnected';
      sendBtn.disabled = true;
      updateStatus('Disconnected - Click Reconnect');
      
      // Auto-reconnect after 3 seconds
      setTimeout(() => {
        if (!isConnected) {
          initializeWebSocket();
        }
      }, 3000);
    };
    
    ws.onerror = (error) => {
      console.error('âŒ WebSocket error:', error);
      updateConnectionStatus('disconnected', 'Connection error');
      serverStatusDiv.textContent = 'âŒ Connection failed';
      sendBtn.disabled = true;
    };
    
  } catch (error) {
    console.error('âŒ Failed to create WebSocket:', error);
    updateConnectionStatus('disconnected', `Failed: ${error.message}`);
    serverStatusDiv.textContent = 'âŒ Initialization failed';
  }
}

// Handle received messages
function handleReceivedMessage(data, isEcho = false) {
  if (data.text) {
    const message = {
      name: isEcho ? 'Server Echo' : (data.name || 'Unknown'),
      text: data.text,
      time: data.time || Date.now(),
      id: data.id || 'msg-' + Date.now(),
      isEcho: isEcho
    };
    addMessage(message);
  }
}

// Add message to display
function addMessage(messageData) {
  messages.unshift(messageData); // Add to beginning for reverse chronological order
  
  // Keep only last 50 messages
  if (messages.length > 50) {
    messages = messages.slice(0, 50);
  }
  
  renderMessages();
  
  // Save to localStorage
  try {
    localStorage.setItem('postman-echo-guestbook', JSON.stringify(messages));
  } catch (e) {
    console.warn('Could not save to localStorage');
  }
}

// Send message function
window.sendMessage = function() {
  if (!isConnected || !ws) {
    alert('Not connected to WebSocket server');
    return;
  }
  
  const name = document.getElementById('name').value.trim();
  const text = document.getElementById('msg').value.trim();
  
  if (!text) {
    alert('Please add a message!');
    return;
  }
  
  const messageData = {
    name: name || 'Anonymous',
    text: text,
    time: Date.now(),
    id: 'sent-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5)
  };
  
  // Add message immediately (optimistic update)
  addMessage(messageData);
  
  // Send to Postman Echo server
  try {
    ws.send(JSON.stringify({
      action: 'message',
      ...messageData
    }));
    messageCount++;
    updateStatus(`Sent ${messageCount} messages`);
    
  } catch (error) {
    console.error('Failed to send message:', error);
    addMessage({
      name: 'System',
      text: `Failed to send message: ${error.message}`,
      time: Date.now(),
      id: 'error-' + Date.now(),
      isError: true
    });
  }
  
  // Clear input
  document.getElementById('msg').value = '';
};

// Render messages
function renderMessages() {
  messagesDiv.innerHTML = '';
  
  messages.forEach(message => {
    const div = document.createElement('div');
    div.className = 'msg';
    
    // Different styling for different message types
    if (message.isEcho) {
      div.style.borderColor = '#00f';
      div.style.background = '#000022';
    }
    if (message.isError) {
      div.style.borderColor = '#f00';
      div.style.background = '#220000';
    }
    if (message.type === 'system') {
      div.style.color = '#0a0';
      div.style.fontStyle = 'italic';
    }
    
    const name = message.isEcho ? 'ðŸ”„ Echo' : (message.name || 'Anonymous');
    div.innerHTML = `<span class="name">${escapeHtml(name)}</span>: ${escapeHtml(message.text)}<br>
                     <span class="time">${new Date(message.time).toLocaleString()}</span>`;
    
    messagesDiv.appendChild(div);
  });
}

// Load messages from localStorage
function loadMessages() {
  try {
    const saved = localStorage.getItem('postman-echo-guestbook');
    if (saved) {
      const parsed = JSON.parse(saved);
      messages = parsed;
      renderMessages();
    }
  } catch (e) {
    console.log('No previous messages found');
  }
}

// Update connection status
function updateConnectionStatus(status, message) {
  connectionStatus.textContent = message;
  connectionStatus.className = `connection-status ${status}`;
}

// Update general status
function updateStatus(message) {
  statusDiv.textContent = `Status: ${message}`;
}

// Utility function
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Set up event listeners
document.getElementById('sendBtn').addEventListener('click', window.sendMessage);
reconnectBtn.addEventListener('click', initializeWebSocket);

// Enter key for messages
document.getElementById('msg').addEventListener('keypress', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    window.sendMessage();
  }
});

// Add welcome message
const welcome = document.createElement('div');
welcome.className = 'msg';
welcome.style.color = '#0a0';
welcome.innerHTML = `
  <strong>ðŸš€ Postman Echo WebSocket Guestbook</strong><br>
  â€¢ Connected to reliable Postman Echo server<br>
  â€¢ Messages are sent to server and echoed back<br>
  â€¢ Perfect for testing WebSocket functionality<br>
  â€¢ Messages persist in browser storage
`;
messagesDiv.appendChild(welcome);

// Initialize
loadMessages();
initializeWebSocket();

console.log('Postman Echo guestbook ready');
</script>

<div class="info-box">
  <h3>ðŸŽ¯ How Postman Echo Works</h3>
  
  <p><strong>WebSocket Server:</strong> <code>wss://ws.postman-echo.com/raw</code></p>
  
  <p><strong>How it works:</strong></p>
  <ul>
    <li>âœ… <strong>Reliable</strong> - Postman's official echo server</li>
    <li>âœ… <strong>Simple</strong> - Echoes back whatever you send</li>
    <li>âœ… <strong>Real-time</strong> - Instant message delivery</li>
    <li>âœ… <strong>Persistent</strong> - Messages saved in browser storage</li>
    <li>âœ… <strong>Cross-platform</strong> - Works on all modern browsers</li>
  </ul>
  
  <p><strong>What happens when you send a message:</strong></p>
  <ol>
    <li>Your message appears immediately (optimistic update)</li>
    <li>Message is sent to Postman Echo server</li>
    <li>Server echoes the message back</li>
    <li>Echoed message appears with ðŸ”„ icon</li>
  </ol>
  
  <p><strong>Perfect for:</strong></p>
  <ul>
    <li>Testing WebSocket functionality</li>
    <li>Demo applications</li>
    <li>Learning WebSocket concepts</li>
    <li>Quick prototypes</li>
  </ul>
  
  <p><strong>Note:</strong> This is an echo server, so messages aren't shared between users. Each user sees only their own messages and echoes.</p>
</div>

</body>
</html>