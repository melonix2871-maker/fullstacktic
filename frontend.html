<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>P2P Live Guestbook – Every Browser is a Node (GitHub Pages 2025)</title>
<style>
  body {font-family:system-ui;background:#000;color:#0f0;padding:30px;margin:0;}
  input,textarea,button{width:100%;padding:12px;margin:10px 0;background:#111;color:#0f0;border:2px solid #0f0;font-size:16px;box-sizing:border-box;}
  button{background:#0f0;color:#000;font-weight:bold;cursor:pointer;}
  .msg{border:1px solid #0f0;padding:10px;margin:10px 0;background:#001100;}
  .name{font-weight:bold;}
  .time{font-size:12px;color:#0a0;}
  #peers{position:fixed;top:10px;right:10px;background:#000;border:1px solid #0f0;padding:8px;border-radius:4px;}
</style>
</head>
<body>

<h1>P2P Live Guestbook – No Server, Every Visitor is a Node</h1>
<p>Type → press Enter → message appears instantly for EVERYONE. Works forever.</p>

<input type="text" id="name" placeholder="Your name (optional)" value="Visitor">
<textarea id="msg" rows="3" placeholder="Your message – appears live everywhere"></textarea>
<button onclick="send()">Send Message</button>

<div id="messages"></div>
<div class="peers" id="peers">Peers: 1 (you)</div>

<!-- Yjs + WebRTC (the magic) -->
<script type="module">
import { Y } from 'https://cdn.jsdelivr.net/npm/yjs@13.6.15/+esm';
import { WebrtcProvider } from 'https://cdn.jsdelivr.net/npm/y-webrtc@10.3.0/+esm';

// Unique room name (change this for your own guestbook)
const ROOM = "global-guestbook-2025-v3";

const ydoc = new Y.Doc();
const messages = ydoc.getArray('messages');

const provider = new WebrtcProvider(ROOM, ydoc, {
  signaling: ['wss://signaling.yjs.dev']  // free public signaling server
});

const messagesDiv = document.getElementById('messages');
const peersDiv = document.getElementById('peers');

function render() {
  messagesDiv.innerHTML = '';
  messages.forEach(item => {
    const div = document.createElement('div');
    div.className = 'msg';
    div.innerHTML = `<span class="name">${escapeHtml(item.name || 'Anon')}</span>: ${escapeHtml(item.text)}<br>
                     <span class="time">${new Date(item.time).toLocaleString()}</span>`;
    messagesDiv.prepend(div);
  });
  peersDiv.textContent = `Peers online: ${provider.room?.webrtcConns.size + 1 || 1}`;
}

// Live sync — new messages appear instantly
messages.observe(render);

// Show peer count
provider.on('peers', ({ added, removed, webrtcPeers }) => {
  peersDiv.textContent = `Peers online: ${webrtcPeers.length + 1}`;
});

function send() {
  const name = document.getElementById('name').value.trim();
  const text = document.getElementById('msg').value.trim();
  if (!text) return;
  messages.push([{
    name: name || 'Anonymous',
    text,
    time: Date.now()
  }]);
  document.getElementById('msg').value = '';
}

document.getElementById('msg').addEventListener('keypress', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

// Load old messages from IndexedDB (persists forever)
render();

// Welcome
messagesDiv.innerHTML = '<div class="msg" style="color:#0a0">You are connected. You are now a node. Messages sync live.</div>' + messagesDiv.innerHTML;

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
</body>
</html>