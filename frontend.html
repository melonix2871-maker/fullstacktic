<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>P2P Live Guestbook – Every Browser is a Node (ESM Fixed, 2025)</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo="> <!-- Fixes favicon 404 -->
<style>
  body {font-family:system-ui;background:#000;color:#0f0;padding:30px;margin:0;}
  input,textarea,button{width:100%;padding:12px;margin:10px 0;background:#111;color:#0f0;border:2px solid #0f0;font-size:16px;box-sizing:border-box;}
  button{background:#0f0;color:#000;font-weight:bold;cursor:pointer;}
  .msg{border:1px solid #0f0;padding:10px;margin:10px 0;background:#001100;}
  .name{font-weight:bold;}
  .time{font-size:12px;color:#0a0;}
  #peers{position:fixed;top:10px;right:10px;background:#000;border:1px solid #0f0;padding:8px;border-radius:4px;}
</style>
</head>
<body>

<h1>P2P Live Guestbook – No Server, Every Visitor is a Node</h1>
<p>Type → press Enter → message appears instantly for EVERYONE. Works forever.</p>

<input type="text" id="name" placeholder="Your name (optional)" value="Visitor">
<textarea id="msg" rows="3" placeholder="Your message – appears live everywhere"></textarea>
<button onclick="send()">Send Message</button>

<div id="messages"></div>
<div class="peers" id="peers">Peers: 1 (you)</div>

<!-- Yjs + Websocket (ESM fixed with ?module) -->
<script type="module">
import * as Y from 'https://cdn.jsdelivr.net/npm/yjs@13.6.18/+esm';
import { WebsocketProvider } from 'https://cdn.jsdelivr.net/npm/y-websocket@3.0.0/+esm';

// Unique room name (change for your own guestbook)
const ROOM = "global-guestbook-2025-v3";

const ydoc = new Y.Doc();
const messages = ydoc.getArray('messages');

// FIXED: Reliable public websocket server (fallback to local if fails)
let provider;
try {
  provider = new WebsocketProvider('wss://demos.yjs.dev', ROOM, ydoc);
} catch (e) {
  console.warn('Websocket failed, using local only:', e);
  provider = null;
}

const messagesDiv = document.getElementById('messages');
const peersDiv = document.getElementById('peers');

// FIXED: Global send function
window.send = function() {
  const name = document.getElementById('name').value.trim();
  const text = document.getElementById('msg').value.trim();
  if (!text) return;
  messages.push([{
    name: name || 'Anonymous',
    text,
    time: Date.now()
  }]);
  document.getElementById('msg').value = '';
};

// Render messages
function render() {
  messagesDiv.innerHTML = '';
  [...messages].reverse().forEach(item => {
    const div = document.createElement('div');
    div.className = 'msg';
    div.innerHTML = `<span class="name">${escapeHtml(item.name || 'Anon')}</span>: ${escapeHtml(item.text)}<br>
                     <span class="time">${new Date(item.time).toLocaleString()}</span>`;
    messagesDiv.prepend(div);
  });
  // Peer count (approx via provider state)
  if (provider && provider.ws) {
    peersDiv.textContent = `Peers online: ${provider.ws.readyState === 1 ? 'Connected (syncing)' : 'Connecting...'}`;
  } else {
    peersDiv.textContent = `Peers online: Local only (persists forever)`;
  }
}

// Live sync — new messages appear instantly
messages.observe(render);

// Enter key to send
document.getElementById('msg').addEventListener('keypress', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

// Initial render
render();

// Welcome message
const welcome = document.createElement('div');
welcome.className = 'msg';
welcome.style.color = '#0a0';
welcome.innerHTML = 'You are connected. You are now a node. Messages sync live via websocket.';
messagesDiv.prepend(welcome);

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
</body>
</html>