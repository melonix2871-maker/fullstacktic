<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>P2P Live Guestbook – Every Browser is a Node (Websocket Sync, Fixed 2025)</title>
<style>
  body {font-family:system-ui;background:#000;color:#0f0;padding:30px;margin:0;}
  input,textarea,button{width:100%;padding:12px;margin:10px 0;background:#111;color:#0f0;border:2px solid #0f0;font-size:16px;box-sizing:border-box;}
  button{background:#0f0;color:#000;font-weight:bold;cursor:pointer;}
  .msg{border:1px solid #0f0;padding:10px;margin:10px 0;background:#001100;}
  .name{font-weight:bold;}
  .time{font-size:12px;color:#0a0;}
  #peers{position:fixed;top:10px;right:10px;background:#000;border:1px solid #0f0;padding:8px;border-radius:4px;}
</style>
</head>
<body>

<h1>P2P Live Guestbook – No Server, Every Visitor is a Node</h1>
<p>Type → press Enter → message appears instantly for EVERYONE. Works forever.</p>

<input type="text" id="name" placeholder="Your name (optional)" value="Visitor">
<textarea id="msg" rows="3" placeholder="Your message – appears live everywhere"></textarea>
<button onclick="send()">Send Message</button>

<div id="messages"></div>
<div class="peers" id="peers">Peers: 1 (you)</div>

<!-- Yjs + Websocket (fixed, reliable public server) -->
<script src="https://unpkg.com/yjs@13.6.18/build/yjs.umd.js"></script>
<script src="https://unpkg.com/y-websocket@1.5.5/dist/y-websocket.umd.js"></script>

<script>
const ROOM = "global-guestbook-2025-v3";
const WS_SERVER = "wss://demos.yjs.dev";  // Reliable public websocket (no WebRTC flakes)

const ydoc = new yjs.Doc();
const messages = ydoc.getArray('messages');
const wsProvider = new yjs.WebsocketProvider(WS_SERVER, ROOM, ydoc);

const messagesDiv = document.getElementById('messages');
const peersDiv = document.getElementById('peers');

// FIXED: Global send function
window.send = function() {
  const name = document.getElementById('name').value.trim();
  const text = document.getElementById('msg').value.trim();
  if (!text) return;
  messages.push([{
    name: name || 'Anonymous',
    text,
    time: Date.now()
  }]);
  document.getElementById('msg').value = '';
};

// Render messages
function render() {
  messagesDiv.innerHTML = '';
  [...messages].reverse().forEach(item => {
    const div = document.createElement('div');
    div.className = 'msg';
    div.innerHTML = `<span class="name">${escapeHtml(item.name || 'Anon')}</span>: ${escapeHtml(item.text)}<br>
                     <span class="time">${new Date(item.time).toLocaleString()}</span>`;
    messagesDiv.prepend(div);
  });
  // Peer count via websocket connections (approx)
  peersDiv.textContent = `Peers online: ${wsProvider.ws?.readyState === 1 ? 'Connected' : 'Offline'}`;
}

// Live sync — new messages appear instantly
messages.observe(render);

// Enter key to send
document.getElementById('msg').addEventListener('keypress', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

// Initial render
render();

// Welcome message
const welcome = document.createElement('div');
welcome.className = 'msg';
welcome.style.color = '#0a0';
welcome.innerHTML = 'You are connected. You are now a node. Messages sync live via websocket.';
messagesDiv.prepend(welcome);

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
</body>
</html>