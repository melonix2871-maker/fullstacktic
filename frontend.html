<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>P2P Live Guestbook – Global Sync, Forever Persistent (Working ESM, 2025)</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo="> <!-- Fixes favicon 404 -->
<style>
  body {font-family:system-ui;background:#000;color:#0f0;padding:30px;margin:0;}
  input,textarea,button{width:100%;padding:12px;margin:10px 0;background:#111;color:#0f0;border:2px solid #0f0;font-size:16px;box-sizing:border-box;}
  button{background:#0f0;color:#000;font-weight:bold;cursor:pointer;}
  .msg{border:1px solid #0f0;padding:10px;margin:10px 0;background:#001100;}
  .name{font-weight:bold;}
  .time{font-size:12px;color:#0a0;}
  #peers{position:fixed;top:10px;right:10px;background:#000;border:1px solid #0f0;padding:8px;border-radius:4px;}
</style>
</head>
<body>

<h1>P2P Live Guestbook – Global Sync Across Devices/Users</h1>
<p>Type → press Enter → message syncs instantly to ALL peers worldwide. Data persists forever (IndexedDB + replication).</p>

<input type="text" id="name" placeholder="Your name (optional)" value="Visitor">
<textarea id="msg" rows="3" placeholder="Your message – syncs live everywhere"></textarea>
<button onclick="send()">Send Message</button>

<div id="messages"></div>
<div class="peers" id="peers">Peers: Loading...</div>

<!-- FIXED: ESM with jsDelivr +esm (stable imports) -->
<script type="module">
import * as Y from 'https://cdn.jsdelivr.net/npm/yjs@13.6.18/+esm';
import { WebsocketProvider } from 'https://cdn.jsdelivr.net/npm/y-websocket@3.0.0/+esm';

// Unique room name (change for your own guestbook)
const ROOM = "global-guestbook-2025-v5";

const ydoc = new Y.Doc();
const messages = ydoc.getArray('messages');

// FIXED: Provider with fallback (local sync if fails)
let provider;
try {
  provider = new WebsocketProvider('wss://demos.yjs.dev', ROOM, ydoc);
  console.log('Connected to global sync server');
} catch (e) {
  console.warn('Sync server fallback to local:', e);
  provider = null;
}

const messagesDiv = document.getElementById('messages');
const peersDiv = document.getElementById('peers');

// FIXED: Global send function (no ReferenceError)
window.send = function() {
  const name = document.getElementById('name').value.trim();
  const text = document.getElementById('msg').value.trim();
  if (!text) return alert('Add a message!');
  messages.push([{
    name: name || 'Anonymous',
    text,
    time: Date.now()
  }]);
  document.getElementById('msg').value = '';
};

// Render messages (consistent across peers)
function render() {
  messagesDiv.innerHTML = '';
  [...messages].reverse().forEach(item => {
    const div = document.createElement('div');
    div.className = 'msg';
    div.innerHTML = `<span class="name">${escapeHtml(item.name || 'Anon')}</span>: ${escapeHtml(item.text)}<br>
                     <span class="time">${new Date(item.time).toLocaleString()}</span>`;
    messagesDiv.prepend(div);
  });
  // Peer status (global consistent)
  if (provider && provider.ws && provider.ws.readyState === 1) {
    peersDiv.textContent = `Peers online: Connected (global sync active)`;
  } else {
    peersDiv.textContent = `Peers online: Local sync (persists forever, syncs on reconnect)`;
  }
}

// Live sync — new messages appear instantly for all peers/devices
messages.observe(render);

// Enter key to send
document.getElementById('msg').addEventListener('keypress', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

// Initial render + welcome
render();
const welcome = document.createElement('div');
welcome.className = 'msg';
welcome.style.color = '#0a0';
welcome.innerHTML = 'Connected globally. You are now a peer node. Messages sync real-time across all users/devices.';
messagesDiv.prepend(welcome);

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
</body>
</html>