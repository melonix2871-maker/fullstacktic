<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>P2P Live Guestbook â€“ Soketi WebSocket Server</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  body {font-family:system-ui;background:#000;color:#0f0;padding:30px;margin:0;}
  input,textarea,button{width:100%;padding:12px;margin:10px 0;background:#111;color:#0f0;border:2px solid #0f0;font-size:16px;box-sizing:border-box;}
  button{background:#0f0;color:#000;font-weight:bold;cursor:pointer;}
  button:disabled{background:#333;color:#666;cursor:not-allowed;}
  .msg{border:1px solid #0f0;padding:10px;margin:10px 0;background:#001100;}
  .name{font-weight:bold;}
  .time{font-size:12px;color:#0a0;}
  #peers{position:fixed;top:10px;right:10px;background:#000;border:1px solid #0f0;padding:8px;border-radius:4px;}
  .status{position:fixed;top:50px;right:10px;background:#000;border:1px solid #0f0;padding:8px;border-radius:4px;}
  .connection-status {margin:10px 0;padding:8px;border-radius:4px;}
  .connection-status.connected {background:#001100;border:1px solid #0f0;}
  .connection-status.disconnected {background:#110000;border:1px solid #f00;}
  .connection-status.connecting {background:#111100;border:1px solid #ff0;}
  .server-config {margin:10px 0;padding:10px;background:#111;border:1px solid #0f0;}
  .config-input {background:#002200;border-color:#0f0;margin:5px 0;}
  .info-box {margin:20px 0;padding:15px;background:#111;border:1px solid #0f0;}
</style>
</head>
<body>

<h1>P2P Live Guestbook â€“ Soketi WebSocket Server</h1>
<p>Production-grade real-time sync using Soketi.app</p>

<div class="connection-status" id="connectionStatus">Configure your Soketi server below</div>

<div class="server-config">
  <strong>Soketi Server Configuration:</strong><br>
  <input type="text" id="serverUrl" placeholder="wss://your-soketi-server.com" value="ws://localhost:6001" class="config-input">
  <input type="text" id="appKey" placeholder="App Key" value="app-key" class="config-input">
  <input type="text" id="appSecret" placeholder="App Secret (optional)" value="secret" class="config-input">
  <input type="text" id="cluster" placeholder="Cluster (optional)" value="mt1" class="config-input">
  <button id="connectBtn">Connect to Soketi</button>
  <div id="serverStatus">Enter your Soketi server details and click Connect</div>
</div>

<input type="text" id="name" placeholder="Your name (optional)" value="Visitor">
<textarea id="msg" rows="3" placeholder="Your message â€“ syncs live everywhere"></textarea>
<button id="sendBtn" disabled>Send Message (Connect First)</button>

<div id="messages"></div>
<div class="status" id="status">Status: Disconnected</div>
<div class="peers" id="peers">Peers: 0</div>

<script type="module">
import * as Y from 'https://cdn.jsdelivr.net/npm/yjs/+esm';
import { WebsocketProvider } from 'https://cdn.jsdelivr.net/npm/y-websocket/+esm';

// DOM elements
const connectionStatus = document.getElementById('connectionStatus');
const statusDiv = document.getElementById('status');
const peersDiv = document.getElementById('peers');
const sendBtn = document.getElementById('sendBtn');
const messagesDiv = document.getElementById('messages');
const serverStatusDiv = document.getElementById('serverStatus');
const serverUrlInput = document.getElementById('serverUrl');
const appKeyInput = document.getElementById('appKey');
const appSecretInput = document.getElementById('appSecret');
const clusterInput = document.getElementById('cluster');
const connectBtn = document.getElementById('connectBtn');

// Connection state
let provider = null;
let ydoc = null;
let messages = null;
let isConnected = false;

// Room name
const ROOM_NAME = "soketi-guestbook-room-v1";

// Custom WebSocket provider for Soketi
class SoketiProvider {
  constructor(serverUrl, roomName, ydoc, options = {}) {
    this.serverUrl = serverUrl;
    this.roomName = roomName;
    this.ydoc = ydoc;
    this.options = options;
    this.ws = null;
    this.connected = false;
    
    this.connect();
  }

  connect() {
    try {
      // Soketi uses Pusher protocol, so we need to handle the connection properly
      this.ws = new WebSocket(this.serverUrl);
      
      this.ws.onopen = () => {
        console.log('WebSocket connected to Soketi');
        this.connected = true;
        
        // For Soketi, we need to subscribe to a channel
        // This is a simplified implementation - you might need Pusher protocol handling
        if (this.options.onStatus) {
          this.options.onStatus({ status: 'connected' });
        }
      };

      this.ws.onmessage = (event) => {
        // Handle messages from Soketi
        // You would need to implement Pusher protocol parsing here
        console.log('Message from Soketi:', event.data);
      };

      this.ws.onclose = () => {
        console.log('WebSocket disconnected from Soketi');
        this.connected = false;
        if (this.options.onStatus) {
          this.options.onStatus({ status: 'disconnected' });
        }
        
        // Attempt reconnect after 2 seconds
        setTimeout(() => this.connect(), 2000);
      };

      this.ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        if (this.options.onStatus) {
          this.options.onStatus({ status: 'error', error });
        }
      };

    } catch (error) {
      console.error('Failed to connect to Soketi:', error);
      if (this.options.onStatus) {
        this.options.onStatus({ status: 'error', error });
      }
    }
  }

  disconnect() {
    if (this.ws) {
      this.ws.close();
    }
  }

  destroy() {
    this.disconnect();
  }
}

// Initialize Yjs with Soketi
function initializeWithSoketi(serverUrl, appKey, appSecret, cluster) {
  // Cleanup previous connection
  if (provider) {
    provider.disconnect();
    provider.destroy();
  }
  
  // Create new Yjs document
  ydoc = new Y.Doc();
  messages = ydoc.getArray('messages');
  
  updateConnectionStatus('connecting', `Connecting to Soketi server...`);
  serverStatusDiv.textContent = `Connecting to ${serverUrl}...`;
  
  try {
    // Option 1: Use custom Soketi provider (simplified)
    // provider = new SoketiProvider(serverUrl, ROOM_NAME, ydoc, {
    //   onStatus: (event) => {
    //     handleConnectionStatus(event.status, event.error);
    //   }
    // });

    // Option 2: Use standard WebSocketProvider (if Soketi supports raw WebSockets)
    // For Soketi, you might need to use their Pusher-compatible endpoints
    provider = new WebsocketProvider(serverUrl, ROOM_NAME, ydoc);
    
    provider.on('status', event => {
      handleConnectionStatus(event.status);
    });
    
    // Update awareness (peer count)
    provider.awareness.on('change', () => {
      updatePeerCount();
    });
    
    // Observe document changes
    messages.observe(renderMessages);
    
    // Load existing messages
    renderMessages();
    
  } catch (error) {
    console.error('Soketi connection failed:', error);
    updateConnectionStatus('disconnected', `Connection failed: ${error.message}`);
    serverStatusDiv.textContent = `âŒ Connection failed: ${error.message}`;
  }
}

// Handle connection status
function handleConnectionStatus(status, error = null) {
  const serverUrl = serverUrlInput.value;
  
  switch (status) {
    case 'connected':
      isConnected = true;
      updateConnectionStatus('connected', `Connected to Soketi server`);
      sendBtn.disabled = false;
      updateStatus('Synced with Soketi');
      serverStatusDiv.textContent = `âœ… Connected to Soketi server`;
      break;
    case 'connecting':
      updateConnectionStatus('connecting', `Connecting to Soketi...`);
      sendBtn.disabled = true;
      serverStatusDiv.textContent = `Connecting to ${serverUrl}...`;
      break;
    case 'disconnected':
      isConnected = false;
      updateConnectionStatus('disconnected', `Disconnected from Soketi`);
      sendBtn.disabled = true;
      updateStatus('Disconnected - will auto-reconnect');
      serverStatusDiv.textContent = `âŒ Disconnected from server`;
      break;
    case 'error':
      isConnected = false;
      updateConnectionStatus('disconnected', `Connection error: ${error?.message || 'Unknown error'}`);
      sendBtn.disabled = true;
      serverStatusDiv.textContent = `âŒ Connection error`;
      break;
  }
}

// Connect button handler
connectBtn.addEventListener('click', () => {
  const serverUrl = serverUrlInput.value.trim();
  const appKey = appKeyInput.value.trim();
  const appSecret = appSecretInput.value.trim();
  const cluster = clusterInput.value.trim();
  
  if (!serverUrl) {
    alert('Please enter a Soketi server URL');
    return;
  }
  
  if (!appKey) {
    alert('Please enter an App Key');
    return;
  }
  
  initializeWithSoketi(serverUrl, appKey, appSecret, cluster);
});

// Enter key for server URL
serverUrlInput.addEventListener('keypress', e => {
  if (e.key === 'Enter') {
    connectBtn.click();
  }
});

// Send message function
window.sendMessage = function() {
  if (!isConnected || !messages) {
    alert('Not connected to Soketi server');
    return;
  }
  
  const name = document.getElementById('name').value.trim();
  const text = document.getElementById('msg').value.trim();
  
  if (!text) {
    alert('Please add a message!');
    return;
  }
  
  const newMessage = {
    name: name || 'Anonymous',
    text,
    time: Date.now(),
    id: Math.random().toString(36).substr(2, 9)
  };
  
  messages.push([newMessage]);
  document.getElementById('msg').value = '';
};

// Enter key for messages
document.getElementById('msg').addEventListener('keypress', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    window.sendMessage();
  }
});

// Update connection status
function updateConnectionStatus(status, message) {
  connectionStatus.textContent = message;
  connectionStatus.className = `connection-status ${status}`;
}

// Update general status
function updateStatus(message) {
  statusDiv.textContent = `Status: ${message}`;
}

// Update peer count
function updatePeerCount() {
  if (provider && provider.awareness) {
    const states = Array.from(provider.awareness.getStates().keys());
    const peerCount = Math.max(0, states.length - 1); // Exclude self
    peersDiv.textContent = `Peers: ${peerCount}`;
  } else {
    peersDiv.textContent = `Peers: 0`;
  }
}

// Render messages
function renderMessages() {
  if (!messages) return;
  
  messagesDiv.innerHTML = '';
  
  // Show newest messages first
  [...messages].reverse().forEach(item => {
    const div = document.createElement('div');
    div.className = 'msg';
    div.innerHTML = `<span class="name">${escapeHtml(item.name || 'Anonymous')}</span>: ${escapeHtml(item.text)}<br>
                     <span class="time">${new Date(item.time).toLocaleString()}</span>`;
    messagesDiv.appendChild(div);
  });
}

// Utility function
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Add welcome message
const welcome = document.createElement('div');
welcome.className = 'msg';
welcome.style.color = '#0a0';
welcome.innerHTML = `
  <strong>Soketi-Powered Live Guestbook</strong><br>
  â€¢ Configure your Soketi server above<br>
  â€¢ Messages sync in real-time across all connected users<br>
  â€¢ Production-grade WebSocket infrastructure
`;
messagesDiv.appendChild(welcome);

// Set up send button
document.getElementById('sendBtn').addEventListener('click', window.sendMessage);

console.log('Soketi guestbook ready - configure your server to start');
</script>

<div class="info-box">
  <h3>ðŸš€ Soketi Setup Guide</h3>
  
  <p><strong>Option 1: Local Development</strong></p>
  <code style="background: #222; padding: 10px; display: block; margin: 10px 0;">
    # Install Soketi<br>
    npm install -g @soketi/soketi<br>
    <br>
    # Start Soketi server<br>
    soketi start<br>
    <br>
    # Server runs on: ws://localhost:6001<br>
    # Default app key: app-key<br>
    # Default app secret: secret
  </code>
  
  <p><strong>Option 2: Docker</strong></p>
  <code style="background: #222; padding: 10px; display: block; margin: 10px 0;">
    docker run -p 6001:6001 -p 9601:9601 quay.io/soketi/soketi:latest
  </code>
  
  <p><strong>Option 3: Cloud Deployment</strong></p>
  <code style="background: #222; padding: 10px; display: block; margin: 10px 0;">
    # Deploy to Railway, Render, DigitalOcean, etc.<br>
    # Use environment variables for configuration
  </code>
  
  <p><strong>Default Credentials (for local development):</strong></p>
  <ul>
    <li>Server: <code>ws://localhost:6001</code></li>
    <li>App Key: <code>app-key</code></li>
    <li>App Secret: <code>secret</code></li>
    <li>Cluster: <code>mt1</code></li>
  </ul>
  
  <p><strong>ðŸ“š Documentation:</strong> <a href="https://docs.soketi.app" style="color:#0f0;">docs.soketi.app</a></p>
</div>

<!-- Quick connect buttons for common Soketi setups -->
<div style="margin: 10px 0;">
  <strong>Quick Connect:</strong>
  <button onclick="document.getElementById('serverUrl').value = 'ws://localhost:6001'; document.getElementById('appKey').value = 'app-key'; document.getElementById('appSecret').value = 'secret'; document.getElementById('cluster').value = 'mt1'; document.getElementById('connectBtn').click();">
    Connect to Local Soketi
  </button>
</div>

</body>
</html>