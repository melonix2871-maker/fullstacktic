<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>P2P Guestbook - No Server Required</title>
<style>
  body {font-family:system-ui;background:#000;color:#0f0;padding:30px;margin:0;}
  input,textarea,button{width:100%;padding:12px;margin:10px 0;background:#111;color:#0f0;border:2px solid #0f0;font-size:16px;box-sizing:border-box;}
  button{background:#0f0;color:#000;font-weight:bold;cursor:pointer;}
  .msg{border:1px solid #0f0;padding:10px;margin:10px 0;background:#001100;}
  .peers{position:fixed;top:10px;right:10px;background:#000;border:1px solid #0f0;padding:8px;}
</style>
</head>
<body>

<h1>P2P Guestbook - Direct Peer Connections</h1>
<p>No server required! Uses WebRTC for direct peer-to-peer connections.</p>

<input type="text" id="name" placeholder="Your name" value="Visitor">
<textarea id="msg" rows="3" placeholder="Your message"></textarea>
<button onclick="send()">Send Message</button>

<div id="messages"></div>
<div class="peers" id="peers">Peers: 0</div>

<script type="module">
import * as Y from 'https://cdn.jsdelivr.net/npm/yjs@14.0.0-14/+esm';
import { WebrtcProvider } from 'https://cdn.jsdelivr.net/npm/y-webrtc@10.3.0/+esm';

const ROOM = "p2p-guestbook-room-2025";

// Create Yjs document
const ydoc = new Y.Doc();
const messages = ydoc.getArray('messages');

// Connect via WebRTC (P2P)
const provider = new WebrtcProvider(ROOM, ydoc, {
  signaling: [
    'wss://y-webrtc-signaling-eu.herokuapp.com',
    'wss://y-webrtc-signaling-us.herokuapp.com',
    'wss://signaling.yjs.dev'
  ],
  password: null,
  awareness: {
    // Share cursor positions, etc.
    name: 'Guestbook User'
  }
});

// UI elements
const messagesDiv = document.getElementById('messages');
const peersDiv = document.getElementById('peers');

// Send function
window.send = function() {
  const name = document.getElementById('name').value.trim();
  const text = document.getElementById('msg').value.trim();
  if (!text) return alert('Add a message!');
  
  messages.push([{
    name: name || 'Anonymous',
    text,
    time: Date.now()
  }]);
  document.getElementById('msg').value = '';
};

// Render messages
function render() {
  messagesDiv.innerHTML = '';
  [...messages].reverse().forEach(item => {
    const div = document.createElement('div');
    div.className = 'msg';
    div.innerHTML = `<strong>${escapeHtml(item.name)}</strong>: ${escapeHtml(item.text)}<br>
                     <small>${new Date(item.time).toLocaleString()}</small>`;
    messagesDiv.appendChild(div);
  });
}

// Update peer count
function updatePeers() {
  const states = Array.from(provider.awareness.getStates().keys());
  peersDiv.textContent = `Peers: ${states.length}`;
}

// Event listeners
messages.observe(render);
provider.awareness.on('change', updatePeers);
document.getElementById('msg').addEventListener('keypress', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

// Initial setup
render();
updatePeers();

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
</body>
</html>