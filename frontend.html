<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>P2P Live Guestbook â€“ Soketi Port 6001</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  body {font-family:system-ui;background:#000;color:#0f0;padding:30px;margin:0;}
  input,textarea,button{width:100%;padding:12px;margin:10px 0;background:#111;color:#0f0;border:2px solid #0f0;font-size:16px;box-sizing:border-box;}
  button{background:#0f0;color:#000;font-weight:bold;cursor:pointer;}
  button:disabled{background:#333;color:#666;cursor:not-allowed;}
  .msg{border:1px solid #0f0;padding:10px;margin:10px 0;background:#001100;}
  .name{font-weight:bold;}
  .time{font-size:12px;color:#0a0;}
  #peers{position:fixed;top:10px;right:10px;background:#000;border:1px solid #0f0;padding:8px;border-radius:4px;}
  .status{position:fixed;top:50px;right:10px;background:#000;border:1px solid #0f0;padding:8px;border-radius:4px;}
  .connection-status {margin:10px 0;padding:8px;border-radius:4px;}
  .connection-status.connected {background:#001100;border:1px solid #0f0;}
  .connection-status.disconnected {background:#110000;border:1px solid #f00;}
  .connection-status.connecting {background:#111100;border:1px solid #ff0;}
  .server-config {margin:10px 0;padding:10px;background:#111;border:1px solid #0f0;}
  .config-input {background:#002200;border-color:#0f0;margin:5px 0;}
  .info-box {margin:20px 0;padding:15px;background:#111;border:1px solid #0f0;}
</style>
</head>
<body>

<h1>P2P Live Guestbook â€“ Soketi Port 6001</h1>
<p>WebSocket connection to port 6001 - TCP confirmed working</p>

<div class="connection-status" id="connectionStatus">Ready to connect to port 6001</div>

<div class="server-config">
  <strong>WebSocket Configuration (Port 6001):</strong><br>
  <input type="text" id="serverHost" placeholder="Server host" value="enginuecoresaas-soketi.uraoah.easypanel.host" class="config-input">
  <input type="number" id="serverPort" placeholder="Port" value="6001" class="config-input">
  <input type="text" id="appKey" placeholder="App Key" value="app-key" class="config-input">
  <input type="text" id="appSecret" placeholder="App Secret" value="secret" class="config-input">
  
  <div style="margin: 10px 0;">
    <strong>Protocol:</strong>
    <label><input type="radio" name="protocol" value="ws" checked> WS (unsecured)</label>
    <label><input type="radio" name="protocol" value="wss"> WSS (secured)</label>
  </div>
  
  <button id="connectBtn">Connect to WebSocket</button>
  <div id="serverStatus">Configure your connection and click Connect</div>
</div>

<input type="text" id="name" placeholder="Your name (optional)" value="Visitor">
<textarea id="msg" rows="3" placeholder="Your message â€“ syncs live everywhere"></textarea>
<button id="sendBtn" disabled>Send Message (Connect First)</button>

<div id="messages"></div>
<div class="status" id="status">Status: Disconnected</div>
<div class="peers" id="peers">Peers: 0</div>

<script type="module">
import * as Y from 'https://cdn.jsdelivr.net/npm/yjs@13.6.27/+esm';
import { WebsocketProvider } from 'https://cdn.jsdelivr.net/npm/y-websocket@3.0.0/+esm';

// DOM elements
const connectionStatus = document.getElementById('connectionStatus');
const statusDiv = document.getElementById('status');
const peersDiv = document.getElementById('peers');
const sendBtn = document.getElementById('sendBtn');
const messagesDiv = document.getElementById('messages');
const serverStatusDiv = document.getElementById('serverStatus');
const serverHostInput = document.getElementById('serverHost');
const serverPortInput = document.getElementById('serverPort');
const appKeyInput = document.getElementById('appKey');
const appSecretInput = document.getElementById('appSecret');
const connectBtn = document.getElementById('connectBtn');

// Connection state
let provider = null;
let ydoc = null;
let messages = null;
let isConnected = false;

// Room name
const ROOM_NAME = "soketi-port-6001-guestbook";

// Get selected protocol
function getProtocol() {
  return document.querySelector('input[name="protocol"]:checked').value;
}

// Build WebSocket URL
function buildWebSocketUrl() {
  const protocol = getProtocol();
  const host = serverHostInput.value.trim();
  const port = serverPortInput.value.trim();
  
  if (port === '80' || port === '443') {
    // Standard ports don't need :port in URL
    return `${protocol}://${host}`;
  } else {
    return `${protocol}://${host}:${port}`;
  }
}

// Test WebSocket connection
function testWebSocketConnection(url) {
  return new Promise((resolve) => {
    const testWs = new WebSocket(url);
    const startTime = Date.now();
    
    testWs.onopen = () => {
      const latency = Date.now() - startTime;
      resolve({ success: true, latency, error: null });
      testWs.close();
    };
    
    testWs.onerror = (error) => {
      resolve({ success: false, latency: null, error: error.type });
    };
    
    testWs.onclose = (event) => {
      if (event.code !== 1000) {
        resolve({ success: false, latency: null, error: `Closed: ${event.code}` });
      }
    };
    
    // Timeout after 5 seconds
    setTimeout(() => {
      if (testWs.readyState === WebSocket.CONNECTING) {
        resolve({ success: false, latency: null, error: 'Timeout' });
        testWs.close();
      }
    }, 5000);
  });
}

// Initialize connection
async function initializeConnection() {
  // Cleanup previous connection
  if (provider) {
    provider.disconnect();
    provider.destroy();
    provider = null;
  }
  
  if (ydoc) {
    ydoc.destroy();
    ydoc = null;
  }
  
  // Create new Yjs document
  ydoc = new Y.Doc();
  messages = ydoc.getArray('messages');
  
  const wsUrl = buildWebSocketUrl();
  
  updateConnectionStatus('connecting', `Testing WebSocket connection...`);
  serverStatusDiv.textContent = `Testing: ${wsUrl}`;
  
  try {
    // Test connection first
    const testResult = await testWebSocketConnection(wsUrl);
    
    if (!testResult.success) {
      throw new Error(`WebSocket test failed: ${testResult.error}`);
    }
    
    serverStatusDiv.textContent = `âœ… WebSocket test passed! Latency: ${testResult.latency}ms. Connecting Yjs...`;
    
    // Now connect Yjs WebSocket provider
    provider = new WebsocketProvider(wsUrl, ROOM_NAME, ydoc);
    
    provider.on('status', event => {
      console.log('Yjs WebSocket status:', event.status);
      
      switch (event.status) {
        case 'connected':
          isConnected = true;
          updateConnectionStatus('connected', `âœ… Connected to WebSocket!`);
          sendBtn.disabled = false;
          updateStatus('Synced via WebSocket');
          serverStatusDiv.textContent = `âœ… Fully connected! Room: ${ROOM_NAME}`;
          break;
          
        case 'connecting':
          updateConnectionStatus('connecting', `Yjs connecting...`);
          sendBtn.disabled = true;
          break;
          
        case 'disconnected':
          isConnected = false;
          updateConnectionStatus('disconnected', `Yjs disconnected`);
          sendBtn.disabled = true;
          updateStatus('Disconnected');
          break;
      }
    });
    
    // Handle awareness (peer count)
    provider.awareness.on('change', () => {
      updatePeerCount();
    });
    
    // Handle sync events
    provider.on('sync', (isSynced) => {
      if (isSynced) {
        console.log('Yjs document synced');
        updateStatus('Document synced');
      }
    });
    
    // Observe messages for changes
    messages.observe(renderMessages);
    
    // Initial render
    renderMessages();
    
  } catch (error) {
    console.error('Connection failed:', error);
    updateConnectionStatus('disconnected', `Connection failed: ${error.message}`);
    serverStatusDiv.textContent = `âŒ ${error.message}`;
  }
}

// Connect button handler
connectBtn.addEventListener('click', async () => {
  const host = serverHostInput.value.trim();
  const port = serverPortInput.value.trim();
  
  if (!host) {
    alert('Please enter a server host');
    return;
  }
  
  if (!port) {
    alert('Please enter a port');
    return;
  }
  
  await initializeConnection();
});

// Update peer count
function updatePeerCount() {
  if (provider && provider.awareness) {
    const states = Array.from(provider.awareness.getStates().keys());
    const peerCount = Math.max(0, states.length - 1); // Exclude self
    peersDiv.textContent = `Peers: ${peerCount}`;
  } else {
    peersDiv.textContent = `Peers: 0`;
  }
}

// Update connection status
function updateConnectionStatus(status, message) {
  connectionStatus.textContent = message;
  connectionStatus.className = `connection-status ${status}`;
}

// Update general status
function updateStatus(message) {
  statusDiv.textContent = `Status: ${message}`;
}

// Send message function
window.sendMessage = function() {
  if (!isConnected || !messages) {
    alert('Not connected to server');
    return;
  }
  
  const name = document.getElementById('name').value.trim();
  const text = document.getElementById('msg').value.trim();
  
  if (!text) {
    alert('Please add a message!');
    return;
  }
  
  const newMessage = {
    name: name || 'Anonymous',
    text,
    time: Date.now(),
    id: Math.random().toString(36).substr(2, 9)
  };
  
  // Add to Yjs array
  messages.push([newMessage]);
  
  // Save to localStorage as backup
  try {
    const existing = JSON.parse(localStorage.getItem(ROOM_NAME) || '[]');
    if (!existing.some(msg => msg.id === newMessage.id)) {
      existing.push(newMessage);
      localStorage.setItem(ROOM_NAME, JSON.stringify(existing));
    }
  } catch (e) {
    console.warn('Could not save to localStorage');
  }
  
  document.getElementById('msg').value = '';
};

// Set up send button
document.getElementById('sendBtn').addEventListener('click', window.sendMessage);

// Enter key for messages
document.getElementById('msg').addEventListener('keypress', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    window.sendMessage();
  }
});

// Render messages
function renderMessages() {
  if (!messages) return;
  
  messagesDiv.innerHTML = '';
  
  // Show newest messages first
  [...messages].reverse().forEach(item => {
    const div = document.createElement('div');
    div.className = 'msg';
    div.innerHTML = `<span class="name">${escapeHtml(item.name || 'Anonymous')}</span>: ${escapeHtml(item.text)}<br>
                     <span class="time">${new Date(item.time).toLocaleString()}</span>`;
    messagesDiv.appendChild(div);
  });
}

// Utility function
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Add welcome message
const welcome = document.createElement('div');
welcome.className = 'msg';
welcome.style.color = '#0a0';
welcome.innerHTML = `
  <strong>ðŸš€ Soketi Port 6001 Guestbook</strong><br>
  â€¢ TCP connection confirmed to port 6001<br>
  â€¢ Using direct WebSocket connection<br>
  â€¢ Real-time sync across all connected users<br>
  â€¢ Production-grade WebSocket infrastructure
`;
messagesDiv.appendChild(welcome);

// Auto-connect on load
setTimeout(() => {
  connectBtn.click();
}, 1000);

console.log('Soketi port 6001 guestbook ready');
</script>

<div class="info-box">
  <h3>ðŸ”§ Port 6001 Connection Guide</h3>
  
  <p><strong>Your Configuration:</strong></p>
  <ul>
    <li>Host: <code>enginuecoresaas-soketi.uraoah.easypanel.host</code></li>
    <li>Port: <code>6001</code> âœ… (TCP confirmed working)</li>
    <li>Protocol: <code>WS</code> (unsecured WebSocket)</li>
  </ul>
  
  <p><strong>Expected WebSocket URL:</strong></p>
  <code>ws://enginuecoresaas-soketi.uraoah.easypanel.host:6001</code>
  
  <p><strong>If connection fails:</strong></p>
  <ol>
    <li>Check if EasyPanel allows WebSocket connections on port 6001</li>
    <li>Verify the domain resolves correctly</li>
    <li>Try both WS and WSS protocols</li>
    <li>Check browser console for detailed error messages</li>
  </ol>
  
  <p><strong>Troubleshooting Steps:</strong></p>
  <ol>
    <li>The page will auto-test the connection on load</li>
    <li>If WebSocket test passes but Yjs fails, it's a Soketi configuration issue</li>
    <li>If both fail, check EasyPanel WebSocket settings</li>
    <li>Contact EasyPanel support if TCP works but WebSocket doesn't</li>
  </ol>
</div>

</body>
</html>