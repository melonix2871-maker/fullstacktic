<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>P2P Live Guestbook ‚Äì Soketi Production Server</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  body {font-family:system-ui;background:#000;color:#0f0;padding:30px;margin:0;}
  input,textarea,button{width:100%;padding:12px;margin:10px 0;background:#111;color:#0f0;border:2px solid #0f0;font-size:16px;box-sizing:border-box;}
  button{background:#0f0;color:#000;font-weight:bold;cursor:pointer;}
  button:disabled{background:#333;color:#666;cursor:not-allowed;}
  .msg{border:1px solid #0f0;padding:10px;margin:10px 0;background:#001100;}
  .name{font-weight:bold;}
  .time{font-size:12px;color:#0a0;}
  #peers{position:fixed;top:10px;right:10px;background:#000;border:1px solid #0f0;padding:8px;border-radius:4px;}
  .status{position:fixed;top:50px;right:10px;background:#000;border:1px solid #0f0;padding:8px;border-radius:4px;}
  .connection-status {margin:10px 0;padding:8px;border-radius:4px;}
  .connection-status.connected {background:#001100;border:1px solid #0f0;}
  .connection-status.disconnected {background:#110000;border:1px solid #f00;}
  .connection-status.connecting {background:#111100;border:1px solid #ff0;}
  .server-config {margin:10px 0;padding:10px;background:#111;border:1px solid #0f0;}
  .config-input {background:#002200;border-color:#0f0;margin:5px 0;}
  .info-box {margin:20px 0;padding:15px;background:#111;border:1px solid #0f0;}
  .quick-connect {margin:10px 0;padding:10px;background:#002200;border:1px solid #0f0;}
</style>
</head>
<body>

<h1>P2P Live Guestbook ‚Äì Soketi Production Server</h1>
<p>Connected to your Soketi server at: <strong>enginuecoresaas-soketi.uraoah.easypanel.host</strong></p>

<div class="connection-status" id="connectionStatus">Ready to connect to Soketi</div>

<div class="server-config">
  <strong>Soketi Server Configuration:</strong><br>
  <input type="text" id="serverUrl" placeholder="WebSocket URL" value="wss://enginuecoresaas-soketi.uraoah.easypanel.host" class="config-input">
  <input type="text" id="appKey" placeholder="App Key" value="app-key" class="config-input">
  <input type="text" id="appSecret" placeholder="App Secret" value="secret" class="config-input">
  <button id="connectBtn">Connect to Soketi</button>
  <div id="serverStatus">Enter your Soketi credentials and click Connect</div>
</div>

<div class="quick-connect">
  <strong>Quick Connect (Common Soketi Setups):</strong><br>
  <button onclick="useDefaultCredentials()">Use Default Soketi Credentials</button>
  <button onclick="useLocalSoketi()">Connect to Local Soketi</button>
</div>

<input type="text" id="name" placeholder="Your name (optional)" value="Visitor">
<textarea id="msg" rows="3" placeholder="Your message ‚Äì syncs live everywhere"></textarea>
<button id="sendBtn" disabled>Send Message (Connect First)</button>

<div id="messages"></div>
<div class="status" id="status">Status: Disconnected</div>
<div class="peers" id="peers">Peers: 0</div>

<script type="module">
import * as Y from 'https://cdn.jsdelivr.net/npm/yjs@13.6.27/+esm';

// DOM elements
const connectionStatus = document.getElementById('connectionStatus');
const statusDiv = document.getElementById('status');
const peersDiv = document.getElementById('peers');
const sendBtn = document.getElementById('sendBtn');
const messagesDiv = document.getElementById('messages');
const serverStatusDiv = document.getElementById('serverStatus');
const serverUrlInput = document.getElementById('serverUrl');
const appKeyInput = document.getElementById('appKey');
const appSecretInput = document.getElementById('appSecret');
const connectBtn = document.getElementById('connectBtn');

// Connection state
let provider = null;
let ydoc = null;
let messages = null;
let isConnected = false;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;

// Room name
const ROOM_NAME = "soketi-guestbook-room-v1";

// Custom WebSocket provider for Soketi
class SoketiYjsProvider {
  constructor(serverUrl, roomName, ydoc, options = {}) {
    this.serverUrl = serverUrl;
    this.roomName = roomName;
    this.ydoc = ydoc;
    this.options = options;
    this.ws = null;
    this.connected = false;
    this.peers = new Set();
    this.reconnectTimeout = null;
    
    this.connect();
  }

  connect() {
    try {
      // Clean up any existing connection
      if (this.ws) {
        this.ws.close();
      }
      
      console.log(`Connecting to Soketi: ${this.serverUrl}`);
      this.ws = new WebSocket(this.serverUrl);
      
      this.ws.onopen = () => {
        console.log('‚úÖ WebSocket connected to Soketi');
        this.connected = true;
        reconnectAttempts = 0;
        
        if (this.options.onStatus) {
          this.options.onStatus({ status: 'connected' });
        }
        
        // Send initial sync request
        this.send({
          type: 'yjs-sync-request',
          room: this.roomName
        });
      };

      this.ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          this.handleMessage(data);
        } catch (error) {
          console.error('Error parsing message:', error);
        }
      };

      this.ws.onclose = (event) => {
        console.log('‚ùå WebSocket disconnected from Soketi:', event.code, event.reason);
        this.connected = false;
        
        if (this.options.onStatus) {
          this.options.onStatus({ status: 'disconnected' });
        }
        
        // Attempt reconnect with exponential backoff
        if (reconnectAttempts < maxReconnectAttempts) {
          const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
          console.log(`Reconnecting in ${delay}ms... (attempt ${reconnectAttempts + 1})`);
          
          this.reconnectTimeout = setTimeout(() => {
            reconnectAttempts++;
            this.connect();
          }, delay);
        }
      };

      this.ws.onerror = (error) => {
        console.error('‚ùå WebSocket error:', error);
        if (this.options.onStatus) {
          this.options.onStatus({ status: 'error', error });
        }
      };

    } catch (error) {
      console.error('‚ùå Failed to connect to Soketi:', error);
      if (this.options.onStatus) {
        this.options.onStatus({ status: 'error', error });
      }
    }
  }

  send(data) {
    if (this.connected && this.ws && this.ws.readyState === WebSocket.OPEN) {
      this.ws.send(JSON.stringify(data));
      return true;
    }
    return false;
  }

  handleMessage(data) {
    switch (data.type) {
      case 'yjs-update':
        // Apply Yjs update from server/other clients
        try {
          const update = new Uint8Array(data.update);
          Y.applyUpdate(this.ydoc, update);
        } catch (error) {
          console.error('Error applying Yjs update:', error);
        }
        break;
        
      case 'peer-joined':
        this.peers.add(data.peerId);
        this.updatePeerCount();
        break;
        
      case 'peer-left':
        this.peers.delete(data.peerId);
        this.updatePeerCount();
        break;
        
      case 'peer-count':
        if (this.options.onPeers) {
          this.options.onPeers(data.count);
        }
        break;
    }
  }

  // Send Yjs updates to server
  sendYjsUpdate(update) {
    this.send({
      type: 'yjs-update',
      room: this.roomName,
      update: Array.from(update)
    });
  }

  updatePeerCount() {
    if (this.options.onPeers) {
      this.options.onPeers(this.peers.size);
    }
  }

  disconnect() {
    if (this.reconnectTimeout) {
      clearTimeout(this.reconnectTimeout);
    }
    if (this.ws) {
      this.ws.close();
    }
  }

  destroy() {
    this.disconnect();
  }
}

// Initialize connection to Soketi
function initializeSoketi(serverUrl, appKey, appSecret) {
  // Cleanup previous connection
  if (provider) {
    provider.disconnect();
    provider.destroy();
  }
  
  // Create new Yjs document
  ydoc = new Y.Doc();
  messages = ydoc.getArray('messages');
  
  updateConnectionStatus('connecting', `Connecting to Soketi server...`);
  serverStatusDiv.textContent = `Connecting to ${serverUrl}...`;
  
  try {
    // Create custom Soketi provider
    provider = new SoketiYjsProvider(serverUrl, ROOM_NAME, ydoc, {
      onStatus: (event) => {
        handleSoketiStatus(event.status, event.error);
      },
      onPeers: (count) => {
        peersDiv.textContent = `Peers: ${count}`;
      }
    });
    
    // Set up Yjs document synchronization
    ydoc.on('update', (update) => {
      // Send Yjs updates to Soketi server
      if (provider && provider.connected) {
        provider.sendYjsUpdate(update);
      }
    });
    
    // Observe messages array for changes
    messages.observe(renderMessages);
    
    // Initial render
    renderMessages();
    
  } catch (error) {
    console.error('Soketi initialization failed:', error);
    updateConnectionStatus('disconnected', `Connection failed: ${error.message}`);
    serverStatusDiv.textContent = `‚ùå Connection failed: ${error.message}`;
  }
}

// Handle Soketi connection status
function handleSoketiStatus(status, error = null) {
  const serverUrl = serverUrlInput.value;
  
  switch (status) {
    case 'connected':
      isConnected = true;
      updateConnectionStatus('connected', `‚úÖ Connected to Soketi server`);
      sendBtn.disabled = false;
      updateStatus('Synced with Soketi server');
      serverStatusDiv.textContent = `‚úÖ Connected to Soketi - Room: ${ROOM_NAME}`;
      break;
      
    case 'connecting':
      updateConnectionStatus('connecting', `Connecting to Soketi...`);
      sendBtn.disabled = true;
      serverStatusDiv.textContent = `Connecting to ${serverUrl}...`;
      break;
      
    case 'disconnected':
      isConnected = false;
      updateConnectionStatus('disconnected', `Disconnected from Soketi`);
      sendBtn.disabled = true;
      updateStatus('Disconnected - attempting to reconnect...');
      serverStatusDiv.textContent = `‚ùå Disconnected - reconnecting...`;
      break;
      
    case 'error':
      isConnected = false;
      updateConnectionStatus('disconnected', `Connection error: ${error?.message || 'Unknown error'}`);
      sendBtn.disabled = true;
      serverStatusDiv.textContent = `‚ùå Connection error`;
      break;
  }
}

// Connect button handler
connectBtn.addEventListener('click', () => {
  const serverUrl = serverUrlInput.value.trim();
  const appKey = appKeyInput.value.trim();
  const appSecret = appSecretInput.value.trim();
  
  if (!serverUrl) {
    alert('Please enter a Soketi server URL');
    return;
  }
  
  if (!appKey) {
    alert('Please enter an App Key');
    return;
  }
  
  initializeSoketi(serverUrl, appKey, appSecret);
});

// Quick connect functions
window.useDefaultCredentials = function() {
  serverUrlInput.value = 'wss://enginuecoresaas-soketi.uraoah.easypanel.host';
  appKeyInput.value = 'app-key';
  appSecretInput.value = 'secret';
  connectBtn.click();
};

window.useLocalSoketi = function() {
  serverUrlInput.value = 'ws://localhost:6001';
  appKeyInput.value = 'app-key';
  appSecretInput.value = 'secret';
  connectBtn.click();
};

// Enter key for server URL
serverUrlInput.addEventListener('keypress', e => {
  if (e.key === 'Enter') {
    connectBtn.click();
  }
});

// Send message function
window.sendMessage = function() {
  if (!isConnected || !messages) {
    alert('Not connected to Soketi server');
    return;
  }
  
  const name = document.getElementById('name').value.trim();
  const text = document.getElementById('msg').value.trim();
  
  if (!text) {
    alert('Please add a message!');
    return;
  }
  
  const newMessage = {
    name: name || 'Anonymous',
    text,
    time: Date.now(),
    id: Math.random().toString(36).substr(2, 9)
  };
  
  // Add to Yjs array (this will trigger sync via the update event)
  messages.push([newMessage]);
  
  // Save to localStorage as backup
  try {
    const existing = JSON.parse(localStorage.getItem(ROOM_NAME) || '[]');
    if (!existing.some(msg => msg.id === newMessage.id)) {
      existing.push(newMessage);
      localStorage.setItem(ROOM_NAME, JSON.stringify(existing));
    }
  } catch (e) {
    console.warn('Could not save to localStorage');
  }
  
  document.getElementById('msg').value = '';
};

// Set up send button
document.getElementById('sendBtn').addEventListener('click', window.sendMessage);

// Enter key for messages
document.getElementById('msg').addEventListener('keypress', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    window.sendMessage();
  }
});

// Update connection status
function updateConnectionStatus(status, message) {
  connectionStatus.textContent = message;
  connectionStatus.className = `connection-status ${status}`;
}

// Update general status
function updateStatus(message) {
  statusDiv.textContent = `Status: ${message}`;
}

// Render messages
function renderMessages() {
  if (!messages) return;
  
  messagesDiv.innerHTML = '';
  
  // Show newest messages first
  [...messages].reverse().forEach(item => {
    const div = document.createElement('div');
    div.className = 'msg';
    div.innerHTML = `<span class="name">${escapeHtml(item.name || 'Anonymous')}</span>: ${escapeHtml(item.text)}<br>
                     <span class="time">${new Date(item.time).toLocaleString()}</span>`;
    messagesDiv.appendChild(div);
  });
}

// Utility function
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Add welcome message
const welcome = document.createElement('div');
welcome.className = 'msg';
welcome.style.color = '#0a0';
welcome.innerHTML = `
  <strong>üöÄ Soketi-Powered Live Guestbook</strong><br>
  ‚Ä¢ Connected to your production Soketi server<br>
  ‚Ä¢ Real-time sync across all users<br>
  ‚Ä¢ Automatic reconnection if disconnected<br>
  ‚Ä¢ Production-grade WebSocket infrastructure
`;
messagesDiv.appendChild(welcome);

console.log('Soketi guestbook ready - click "Use Default Credentials" to connect');

// Auto-connect if credentials are already filled
if (serverUrlInput.value && appKeyInput.value) {
  setTimeout(() => connectBtn.click(), 1000);
}
</script>

<div class="info-box">
  <h3>üîß Soketi Server Information</h3>
  
  <p><strong>Your Soketi Server:</strong></p>
  <ul>
    <li>URL: <code>enginuecoresaas-soketi.uraoah.easypanel.host</code></li>
    <li>WebSocket: <code>wss://enginuecoresaas-soketi.uraoah.easypanel.host</code></li>
    <li>Status: ‚úÖ Running on EasyPanel</li>
  </ul>
  
  <p><strong>Next Steps:</strong></p>
  <ol>
    <li>Click "Use Default Credentials" to test connection</li>
    <li>If connection fails, check your EasyPanel environment variables</li>
    <li>Open this page in multiple browsers/tabs to test real-time sync</li>
    <li>Monitor connections in your EasyPanel logs</li>
  </ol>
  
  <p><strong>Expected Environment Variables in EasyPanel:</strong></p>
  <ul>
    <li><code>SOKETI_DEFAULT_APP_ID</code> - Your app ID</li>
    <li><code>SOKETI_DEFAULT_APP_KEY</code> - App key (usually "app-key")</li>
    <li><code>SOKETI_DEFAULT_APP_SECRET</code> - App secret (usually "secret")</li>
  </ul>
</div>

</body>
</html>